# Recharting the Weak Silent-Step Spectrum {#sec-weak-spectrum}

::: {.content-hidden when-format="pdf"}
{{< include style/macros.md >}}
:::


## Weak Equivalences in General

For practical problems, the equivalences we have discussed so far usually are *too strong*.
They notice where in a process the *internal action* $\tau$ happens, that is: 
$$\literal{a} \nbeq{} \ccsprefix{\tau} \literal{a} \nbeq{} \ccsprefix{\tau} \ccsprefix{\tau} \literal{a} \nbeq{} \ccsprefix{\tau}\ccsprefix{\literal{a}} \tau  \nbeq{} \ccsprefix{\literal{a}} \tau$$
For real-world models, we want equivalences to disregard such kinds of internal behavior as “silent”  when comparing processes, such that:
$$\literal{a} \beq{} \ccsprefix{\tau} \literal{a} \beq{} \ccsprefix{\tau} \ccsprefix{\tau} \literal{a} \beq{} \ccsprefix{\tau}\ccsprefix{\literal{a}} \tau  \beq{} \ccsprefix{\literal{a}} \tau$$
Equivalences with this feature are called *weak*, alluding to the fact that they are less distinctive than the “strong” equivalences that treat $\tau$ like any other action.

The basic principle is that weak equivalences should maintain that some internal behavior happening before or after a visible action does not make a difference from the point of view of an observer.
But this idea leads into a lot of fine points.

### Silent Transitions {#sec-silent-transitions}

:::{#def-transition-systems-with-silent-steps}

For transition systems $\system=(\states,\actions,\step{})$ with an *internal action* $\tau \in \actions$, we call $\step{\tau}$-transitions “silent” and define special transition relations plus HML modalities:

Internal transition relation
: $p \stepweak p'$ iff $p \step{\tau}^* p'$, where $\step{\tau}^*$ is the reflexive transitive closure of silent steps.
: The *internal* modality $\hmleps \varphi$ has $p \in \semantics{\hmleps\varphi}$ iff there is $p' \in \semantics{\varphi}$ with $p \stepweak p'$.

Optional transition relation
: $p \stepopt{\alpha} p'$ iff $p \step{\alpha} p'$, or if $\alpha = \tau$ and $p = p'$.
: We accompany it by the *optional* step modality $\hmlopt{\alpha} \varphi$ with $p \in \semantics{\hmlopt{\alpha}\varphi}$ iff there is $p' \in \semantics{\varphi}$ with $p \stepopt{\alpha} p'$.

Stable process
: A process $p$ is called *stable* iff $p \nostep{\tau}$.
: (In HML, we can use $\hmlneg\hmlobs{\tau}\hmltrue$ to express stabilization.)

Again, we implicitly lift the relations to sets of processes, that is for instance, $P \stepweak P'$ (with $P, P' \subseteq \states$) iff $P' = \set{ p' \in \states \mid \exists p \in P \ldotp p \stepweak p'}$.
:::

We use the convention that $\alpha$ continues to stand for elements of $\actions$, while $a$ comes from $\actions \setminus \set{\tau}$.



### Weak Traces and Weak Bisimulation

@def-traces and @def-trace-eq

::: {#def-weak-traces}
#### Weak Traces, Preorder, and Equivalence

The set of *weak traces* of a state $\wtraces{p} \subseteq (\actions \setminus \set{\tau})^*$ is recursively defined as

- $\emptyword ∈ \wtraces{p}$,
- $a \cdot \vec w ∈ \wtraces{p}$ if there is $p'$ with $p \stepweak \step a p'$ and $\vec w ∈ \wtraces{p'}$.{{<isb abbreviation LTS LTS_Tau.weak_traces>}}^[The Isabelle theory has a slightly different definition that also allows $\tau$s in the trace words, which do not necessary stand for proper $\step{\tau}$-steps.]

Two states are *weakly trace-preordered*, $p \bpreord{WT} q$, if $\wtraces{p} ⊆ \wtraces{q}$.{{<isb definition LTS LTS_Tau.weakly_trace_preordered>}}
As usual, if both directions are maintained, the states are called *weakly trace-equivalent*, $p \beq{WT} q$.
:::

::: {#def-weak-bisimilarity}
#### Weak Simulation, Preorder and Equivalences

A relation, $\rel R ⊆ \states × \states$, is called a *weak simulation* if, for each $(p, q) ∈ \rel R$,

- if $p \step a p'$ with $a ∈ \actions \setminus{\tau}$, there is a $q'$ with $q \stepweak\step{a}\stepweak q'$ and $(p', q') ∈ \rel R$; and
- if $p \step \tau p'$, there is a $q'$ with $q \stepweak q'$ and $(p', q') ∈ \rel R$.

Weak simulation preorder, weak simulation equivalence and weak bisimilarity analogously to @def-bisimilarity:

- $p$ is *weakly simulated by* $q$, $p \bpreord{WS} q$, iff there is a weak simulation $\rel R$ with $(p, q) ∈ \rel R$.
- $p$ is *weakly similar* to $q$, $p \beq{WS} q$, iff $p \bpreord{WS} q$ and $q \bpreord{WS} p$.
- $p$ is *weakly bisimilar* to $q$, $p \beq{WB} q$, iff there is a *symmetric* weak simulation $\rel R$ (i.e. $\rel R = \inverse{\rel R}$) with $(p, q) ∈ \rel R$.
:::


::: {#exm-phil-weak-eqs}
For the processes of @exm-ts (repeated in @fig-ts-determinism-repeated), the weak traces would be $\wtraces{\literal{P}} = \set{\emptyword, \literal{a}, \literal{b}} = \wtraces{\literal Q}$.
Consequently, $\literal P$ and $\literal Q$ are weakly trace-equivalent, $\literal P \beq{WT} \literal Q$.

In @exm-phil-sim, we have observed that the two processes are not (strongly) similar because $\literal Q \nbpreord{S} \literal P$ due to $\hmlobs{τ}\hmlands\set{\hmlobs{\literal a}, \hmlobs{\literal b}}$.
Due to the weakening, however, there is a weak simulation for this direction, namely:
$\set{(\literal{Q}, \literal{P}), (\literal{q_{ab}}, \literal{P}), (\literal{q_1}, \literal{p_1}), (\literal{q_2}, \literal{p_2})}$.
Therefore, $\literal P \beq{WS} \literal Q$!
A mutual weak simulation $R_{\literal{PQ}}$ to justify this is drawn in dashed blue in @fig-ts-determinism-repeated.

::::{#fig-ts-determinism-repeated}
```tikz
\begin{tikzpicture}[->,auto,node distance=2cm,
    rel/.style={dashed,blue}]
  \node[state] (P){$\literal{P}$};
  \node[state, below left of=P] (PA){$\literal{p_a}$};
  \node[state, below right of=P] (PB){$\literal{p_b}$};
  \node[state, below of=PA] (P1){$\literal{p_1}$};
  \node[state, below of=PB] (P2){$\literal{p_2}$};
  \path
    (P)
      edge node[swap] {$\tau$} (PA)
      edge node {$\tau$} (PB)
    (PA)
      edge node {$\literal{a}\vphantom{\literal{b}}$} (P1)
    (PB)
      edge node {$\literal{b}$} (P2);

  \node[state, right=5cm of P] (Q){$\literal{Q}$};
  \node[state, below of=Q] (QAB){$\literal{q_{ab}}$};
  \node[state, below left of=QAB] (Q1){$\literal{q_1}$};
  \node[state, below right of=QAB] (Q2){$\literal{q_2}$};
  \path
    (Q)
      edge node {$\tau$} (QAB)
    (QAB)
      edge node[swap] {$\literal{a}\vphantom{\literal{b}}$} (Q1)
      edge node {$\literal{b}$} (Q2);
   \path[rel]
    (P) edge[<->, bend left=15] node {$\rel R_{\literal{PQ}}$} (Q)
    (PA) edge[->, bend left=10] node {} (Q)
    (PB) edge[->, bend left=10] node {} (Q)
    (QAB) edge[->, bend right=10] node {} (P)
    (P1) edge[<->, bend left=15] node {} (Q1)
    (P2) edge[<->, bend left=15] node {} (Q2);
\end{tikzpicture}
```

A mutual weak simulation on the original philosopher example.
::::
:::

### The Need for Other Equivalences

- Weak failures
- Stability...

## Case Studies

### Peterson's Mutual Exclusion

### Bell's Parellelizing Compiler Optimization

### Congruence-Properties of Abstraction

... Closing hint: congruence even messier in the weak spectrum, e.g. weak bisim not congruence for +.

## Expressing the Weak Spectrum with Quantities

### Weak Bisimilarities

### HML of Stability-Respecting Branching Bisimilarity

:::{#def-hml-srbb}

#### Branching Hennessy--Milner Logic
We define *stability-respecting branching* Hennessy--Milner modal logic,
$\hmlsrbb$, over an alphabet of actions $\actions$ by the following context-free grammar starting with $\varphi$:
$$
\begin{array}{rllr}
    \varphi {} ::= {} & \hmleps\chi & & \text{“delayed observation”} \\
        | \quad & \hmlands \set{\psi, \psi, ...} & & \text{“immediate conjunction”} \\
    \chi {} ::= {} & \hmlobs{a}\varphi & \quad\text{with } a \in \actions \setminus \set{\tau} & \text{“observation”} \\
    | \quad & \hmlands \set{\psi, \psi, ... } & & \text{“standard conjunction”} \\
    | \quad & \hmlands \set{\hmlneg\hmlobs{\tau}\hmltrue, \psi, \psi, ...} & & \text{“stable conjunction”} \\
    | \quad & \hmlands \set{\hmlopt{\alpha}\varphi, \psi, \psi, ...} &
    \quad \text{with } \alpha \in \actions & \text{“branching conjunction”} \\
    \psi {} ::= {} & \hmlneg\hmleps\chi \mid \hmleps\chi & & \text{“negative / positive conjuncts”}
\end{array}
$$
We consider the semantics of $\hmlsrbb$ to be given by @def-hml-semantics and @def-transition-systems-with-silent-steps.
:::

The name already alludes to $\hmlsrbb$ as a whole characterizing stability-respecting branching bisimilarity.
The power of @def-hml-srbb to distinguish mirrors exactly the power of @def-branching-bisim to equate:

::: {#lem-srbb-characterization}

$\hmlsrbb$ characterizes stability-respecting branching bisimilarity, that is,
there is a stability-respecting branching bisimulation $\rel R$ with $(p,q) \in \rel R$
precisely if there is no formula $\varphi \in \hmlsrbb$ with $p \in \semantics{\varphi}$ and $q \notin \semantics{\varphi}$.{{<isb lemma Branching_Bisimilarity LTS_Tau.sr_branching_bisim_is_hmlsrbb>}}
:::

The paper proof in @bj2025silentStepSpectroscopyJournal proceeds quite similarly to other Hennessy–Milner theorems, as showcased in @thm-hennessy-milner.

### Syntactic Expressiveness

We adapt the notions of @sec-strong-notions for the weak spectrum to distinguish the new kinds of conjunctions:

- Modal depth of *observations* ($\hmlobs{a}$, $\hmlopt{\alpha}$).
- **New:** Nesting depth of *branching conjunctions* (with one $\hmlopt{\alpha}$-observation conjunct, not starting with $\hmleps$).
- **New:** Nesting depth of *unstable conjunctions* (that do not enforce stability by a $\hmlneg \hmlobs{\tau} \hmltrue$-conjunct).
- **New:** Nesting depth of *stable conjunctions* (that do enforce stability by a $\hmlneg \hmlobs{\tau} \hmltrue$-conjunct).
- Nesting depth of *immediate conjunctions* (that are not preceded by $\hmleps$).
- Maximal modal depth of *positive conjuncts* in conjunctions.^[To simplify matters, we drop the two kinds of positive conjunct depths.]
- Maximal modal depth of *negative conjuncts* in conjunctions.
- Nesting depth of *negations*.


::: {#def-weak-spectrum}
#### Weak Spectrum

We define the *weak notions of observability* using vectors of extended naturals
$$\notions^\literal{weak} ≔
\natsext^8,
$$
ordered by pointwise comparison of vector components.

We capture the family of weak observation languages $\observationsvar[\literal{weak}]{N \in \notions^\literal{weak}}$ by providing an expressiveness price function $\expr[\literal{weak}] \colon \hmlsrbb \rightarrow \notions^\literal{weak}$ with $\observationsvar[\literal{weak}]{N} = \set{ \varphi \mid \expr[\literal{weak}](\varphi) \leq N}$.
It is defined in mutual recursion with $\expr[\varepsilon]$ and $\expr[\wedge]$ as follows---if multiple rules apply, pick the first one:
$$
\begin{array}{rl}
  \expr[\literal{weak}]\left(\hmltrue\right) \defeq
  \expr[\varepsilon]\left(\hmltrue\right) & \defeq
  \zerovec
  \\
  \textstyle\expr[\literal{weak}]\left(\hmleps\chi\right) & \defeq
  \textstyle\expr[\varepsilon]\left(\chi\right)
  \\
  \textstyle\expr[\literal{weak}]\left(\hmlands\Psi\right) & \defeq
  \unit{5} + \textstyle\expr[\varepsilon]\left(\hmlands \Psi\right)
  \\
  \expr[\varepsilon]\left(\hmlobs{a}\varphi\right) & \defeq
  \unit{1} + \expr[\literal{weak}]\left(\varphi\right)
  \\
  \textstyle\expr[\varepsilon]\left(\hmlands \Psi\right) & \defeq
  \sup\;\set{ \expr[\wedge]\left(\psi\right) \mid \psi \in \Psi } +
  \begin{cases}
      \unit{4} & \text{if } \hmlneg\hmlobs{\tau}\hmltrue \in \Psi\\
      \unit{2} + \unit{3} & \text{if there is } \hmlopt{\alpha}\varphi \in \Psi \\
      \unit{3} & \text{otherwise}
  \end{cases}
  \\
  \expr[\wedge]\left(\hmlneg\hmlobs{\tau}\hmltrue\right) & \defeq
  (0,0,0,0,0,0,0,1)
  \\
  \expr[\wedge]\left(\hmlneg\varphi\right) & \defeq
  \sup\;\set{ \unit{8} + \expr[\literal{weak}]\left(\varphi\right),\quad
      (0,0,0,0,0,0,\left(\expr[\literal{weak}]\left(\varphi\right)\right)_1,0) }
  \\
  \expr[\wedge]\left(\hmlopt{\alpha}\varphi\right) & \defeq
  \sup\;\set{ \unit{1} + \expr[\literal{weak}]\left(\varphi\right),\quad
      (0,0,0,0,0,1 + \left(\expr[\literal{weak}]\left(\varphi\right)\right)_1,0,0) }
  \\
  \expr[\wedge]\left(\varphi\right) & \defeq
  \sup\;\set{ \hphantom{\unit{8} + {}} \expr[\literal{weak}]\left(\varphi\right),\quad
      (0,0,0,0,0,\left(\expr[\literal{weak}]\left(\varphi\right)\right)_1,0,0) }
\end{array}
$$
:::

### Weak Spectrum

## Discussion

